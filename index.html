<!DOCTYPE html>
<!--
  All-in-One Drive Note POC • 2025-07-03
  Usage:
    1. Paste your Google OAuth Client ID + API Key in Settings.
    2. Sign in → Save ⭱ → Load ⭳ to sync quick-note.txt in Drive.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Quick-Note ⇆ Google Drive</title>
  <style>
    :root{--bg:#f5f7fa;--fg:#222;--accent:#1669f2}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{display:flex;flex-direction:column;height:100vh;
         background:var(--bg);color:var(--fg);
         font-family:system-ui,sans-serif}
    header,footer{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:1rem}
    header{display:flex;gap:.5rem;align-items:center}
    details>summary{cursor:pointer;font-weight:600}
    input,button{font-size:1rem}
    input{flex:1;max-width:200px;padding:.5rem;border:1px solid #ccc;border-radius:4px}
    textarea{flex:1;width:100%;padding:1rem;border:none;resize:none;outline:none;
             font-size:1rem;line-height:1.4}
    footer{display:flex;gap:1rem;justify-content:center}
    button{padding:.75rem 1.5rem;border:none;border-radius:4px;
           background:var(--accent);color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    @media(max-width:600px){
      header,footer{padding:.5rem}
      input{max-width:none;width:100%}
      button{flex:1;padding:.5rem;font-size:.9rem}
      textarea{font-size:.95rem}
    }
  </style>
</head>
<body>

  <header>
    <details open>
      <summary>Settings ⚙️</summary>
      <label>Client ID:
        <input id="clientId" placeholder="G-Client-ID" />
      </label>
      <label>API Key:
        <input id="apiKey" placeholder="G-API-Key" />
      </label>
      <button id="signin" disabled>Sign in</button>
    </details>
  </header>

  <textarea id="note" placeholder="Type your note…"></textarea>

  <footer>
    <button id="load" disabled>Load ⭳</button>
    <button id="save" disabled>Save ⭱</button>
  </footer>

  <!-- 1) Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- 2) Google API Client -->
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script type="module">
  // ==== Config & state ====
  const FILE_NAME = 'quick-note.txt';
  let tokenClient, accessToken, fileId;
  
  // ==== DOM refs ====
  const clientIn = document.getElementById('clientId');
  const keyIn    = document.getElementById('apiKey');
  const signBtn  = document.getElementById('signin');
  const loadBtn  = document.getElementById('load');
  const saveBtn  = document.getElementById('save');
  const noteTA   = document.getElementById('note');

  // ==== localStorage helpers ====
  const LS = {
    get clientId(){ return localStorage.getItem('gClientId') },
    set clientId(v){ localStorage.setItem('gClientId',v) },
    get apiKey(){ return localStorage.getItem('gApiKey') },
    set apiKey(v){ localStorage.setItem('gApiKey',v) },
    get fileId(){ return localStorage.getItem('noteFileId') },
    set fileId(v){ localStorage.setItem('noteFileId',v) }
  };

  // ==== Init ====
  window.addEventListener('DOMContentLoaded',()=>{
    // restore saved creds
    if(LS.clientId) clientIn.value = LS.clientId;
    if(LS.apiKey)   keyIn.value    = LS.apiKey;
    updateSignState();

    clientIn.oninput = () => { LS.clientId = clientIn.value.trim(); updateSignState(); };
    keyIn.oninput    = () => { LS.apiKey   = keyIn.value.trim();   updateSignState(); };

    signBtn.onclick = handleSignIn;
    saveBtn.onclick = saveNote;
    loadBtn.onclick = loadNote;

    // Ctrl/Cmd+S → Save
    document.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey)&&e.key==='s'){
        e.preventDefault(); saveNote();
      }
    });
  });

  function updateSignState(){
    signBtn.disabled = !(clientIn.value.trim() && keyIn.value.trim());
  }

  // ==== Sign-in & gapi init ====
  async function handleSignIn(){
    // 1) Google Identity token
    tokenClient ??= google.accounts.oauth2.initTokenClient({
      client_id: clientIn.value.trim(),
      scope: 'https://www.googleapis.com/auth/drive.file',
      callback: resp => {
        accessToken = resp.access_token;
        // 2) load gapi and init
        gapi.load('client', async ()=>{
          await gapi.client.init({
            apiKey: keyIn.value.trim(),
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
          });
          // set the OAuth token
          gapi.client.setToken({ access_token: accessToken });
          signBtn.textContent = 'Signed in ✔';
          signBtn.disabled = true;
          saveBtn.disabled = loadBtn.disabled = false;
        });
      }
    });
    tokenClient.requestAccessToken({ prompt:'consent' });
  }

  // ==== File helpers ====
  async function ensureFileId(){
    if(LS.fileId) return LS.fileId;
    // list files named FILE_NAME
    const res = await gapi.client.drive.files.list({
      q: `name='${FILE_NAME}' and trashed=false`,
      fields: 'files(id)',
      pageSize: 1
    });
    const files = res.result.files;
    if(files?.length){
      LS.fileId = files[0].id;
      return LS.fileId;
    }
    return null;
  }

  // ==== Save ====
  async function saveNote(){
    try{
      const id = await ensureFileId();
      const resource = { name: FILE_NAME, mimeType: 'text/plain' };
      const media    = { mimeType: 'text/plain', body: noteTA.value };

      let resp;
      if(!id){
        resp = await gapi.client.drive.files.create({
          resource, media, fields:'id'
        });
        LS.fileId = resp.result.id;
      } else {
        resp = await gapi.client.drive.files.update({
          fileId: id, media, fields:'id'
        });
      }
      alert('Saved ✔');
    }catch(e){
      console.error(e);
      alert('Save error: '+e.message);
    }
  }

  // ==== Load ====
  async function loadNote(){
    try{
      const id = await ensureFileId();
      if(!id){ alert('No file yet—hit Save first!'); return; }
      // fetch raw content (alt=media)
      const res = await gapi.client.drive.files.get({
        fileId: id, alt: 'media'
      });
      noteTA.value = res.body; 
      alert('Loaded ✔');
    }catch(e){
      console.error(e);
      alert('Load error: '+e.message);
    }
  }
  </script>
</body>
</html>

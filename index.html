<!DOCTYPE html>
<!--
  Google-Drive Note POC • Updated for Mobile Responsiveness
  Usage:
    1. Paste your Google OAuth Client ID in Settings.
    2. Sign in, then Load ⭳ or Save ⭱.
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- :contentReference[oaicite:11]{index=11} -->
  <title>Quick-Note ⇆ Google Drive</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --fg: #222;
      --accent: #1669f2;
    }
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;                /* flex layout :contentReference[oaicite:12]{index=12} */
      flex-direction: column;
      height: 100vh;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, sans-serif;
    }
    header, footer {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
      padding: 1rem;
    }
    header {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    details > summary {
      cursor: pointer;
      font-weight: 600;
    }
    input[type="text"] {
      flex: 1;
      max-width: 420px;
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea {
      flex: 1;                     /* fill available space :contentReference[oaicite:13]{index=13} */
      width: 100%;
      padding: 1rem;
      border: none;
      resize: none;
      font-size: 1rem;
      line-height: 1.4;
      outline: none;
    }
    footer {
      display: flex;               /* sticky footer pattern :contentReference[oaicite:14]{index=14} */
      justify-content: center;
      gap: 1rem;
    }
    button {
      flex: 0 1 auto;
      padding: .75rem 1.5rem;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    button:disabled {
      opacity: .5;                /* disabled styling :contentReference[oaicite:15]{index=15} */
      cursor: not-allowed;
    }
    /* Mobile adjustments */
    @media (max-width: 600px) {    /* media query for small screens :contentReference[oaicite:16]{index=16} */
      header, footer {
        padding: .5rem;
      }
      input[type="text"] {
        width: 100%;
        max-width: none;
      }
      button {
        flex: 1; 
        font-size: .9rem;
        padding: .5rem;
      }
      textarea {
        font-size: .95rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <details open>
      <summary>Settings ⚙️</summary>
      <label>
        Client ID:
        <input id="clientId" type="text" placeholder="Paste your Google OAuth Client ID" />
      </label>
      <button id="signin" disabled>Sign in with Google</button>
    </details>
  </header>

  <textarea id="note" placeholder="Start typing…"></textarea>

  <footer>
    <button id="load" disabled>Load ⭳</button>
    <button id="save" disabled>Save ⭱</button>
  </footer>

  <!-- Google Identity Services JS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script type="module">
    /* ==== Config & state ==== */
    const SCOPE = 'https://www.googleapis.com/auth/drive.file';
    const FILE_NAME = 'quick-note.txt';
    let accessToken = null, tokenClient = null;

    /* ==== DOM elements ==== */
    const clientIdInput = document.getElementById('clientId');
    const signInBtn     = document.getElementById('signin');
    const loadBtn       = document.getElementById('load');
    const saveBtn       = document.getElementById('save');
    const noteArea      = document.getElementById('note');

    /* ==== localStorage helpers ==== */
    const LS = {
      get id()       { return localStorage.getItem('noteFileId'); },
      set id(v)      { localStorage.setItem('noteFileId', v); },
      get clientId() { return localStorage.getItem('gClientId'); },
      set clientId(v){ localStorage.setItem('gClientId', v); }
    };

    /* ==== Initialization ==== */
    window.addEventListener('DOMContentLoaded', () => {
      if (LS.clientId) clientIdInput.value = LS.clientId;
      updateSignInState();
      clientIdInput.addEventListener('input', () => {
        LS.clientId = clientIdInput.value.trim();
        updateSignInState();
      });
      signInBtn.addEventListener('click', signIn);
      saveBtn.addEventListener('click', saveNote);
      loadBtn.addEventListener('click', loadNote);
      document.addEventListener('keydown', e => {
        if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s') {
          e.preventDefault(); saveNote();
        }
      });
    });

    function updateSignInState(){
      signInBtn.disabled = !clientIdInput.value.trim();
    }

    /* ==== Google OAuth ==== */
    function signIn(){
      if (accessToken) return;
      if (!google?.accounts?.oauth2) {
        alert('GIS SDK load failed');
        return;
      }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientIdInput.value.trim(),
        scope: SCOPE,
        callback: resp => {
          if (resp.error) {
            alert('Auth error: '+resp.error);
            return;
          }
          accessToken = resp.access_token;
          signInBtn.textContent = 'Signed in ✔';
          signInBtn.disabled = true;
          saveBtn.disabled = loadBtn.disabled = false;
        }
      });
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    /* ==== Drive API helpers ==== */
    async function authorizedFetch(url, opts={}){
      if (!accessToken) { alert('Sign in first'); throw 0; }
      opts.headers = { ...(opts.headers||{}), Authorization:`Bearer ${accessToken}` };
      const res = await fetch(url, opts);
      if (res.status===401) {
        tokenClient.requestAccessToken({ prompt: '' });
        throw new Error('Token expired');
      }
      return res;
    }

    async function getFileId(){
      if (LS.id) return LS.id;
      const q = encodeURIComponent(`name='${FILE_NAME}' and trashed=false`);
      const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)&pageSize=1`;
      const res = await authorizedFetch(url);
      const { files } = await res.json();
      if (files?.length){
        LS.id = files[0].id;
        return LS.id;
      }
      return null;
    }

    /* ==== Save & Load ==== */
    async function saveNote(){
      try {
        const id = await getFileId();
        const meta = { name: FILE_NAME, mimeType: 'text/plain' };
        const boundary = '-------314159265358979323846';
        const delim = '\\r\\n--'+boundary+'\\r\\n', close='\\r\\n--'+boundary+'--';
        const body = delim+'Content-Type:application/json; charset=UTF-8\\r\\n\\r\\n'
                  +JSON.stringify(meta)
                  +delim+'Content-Type:text/plain\\r\\n\\r\\n'+noteArea.value+close;
        const method = id?'PATCH':'POST';
        const url = id
          ?`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=multipart`
          :'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
        const res = await authorizedFetch(url,{
          method,
          headers:{'Content-Type':`multipart/related; boundary=${boundary}`},
          body
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!id) LS.id=data.id;
        alert('Saved ✔');
      } catch(e){
        console.error(e); alert('Save failed: '+e.message);
      }
    }

    async function loadNote(){
      try {
        const id = await getFileId();
        if (!id) { alert('No note—save one first!'); return; }
        const res = await authorizedFetch(
          `https://www.googleapis.com/drive/v3/files/${id}?alt=media`
        );
        if (!res.ok) throw new Error(await res.text());
        noteArea.value = await res.text();
        alert('Loaded ✔');
      } catch(e){
        console.error(e); alert('Load failed: '+e.message);
      }
    }
  </script>
</body>
</html>
